{% extends 'base.html' %}
{% load static %}

{% block title %}{{ raid_name }} Finder{% endblock %}

{% block extra_css %}
<script src="//cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>

<style>
    /* Slots de Rol */
    .role-box {
        width: 32px; height: 32px;
        border-radius: 4px; border: 2px solid #555;
        background-color: rgba(60, 60, 60, 0.6); 
        margin-right: 3px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(4px);
    }
    .role-box.tank { border-color: #439bff; background-color: rgba(74, 116, 233, 0.4); }
    .role-box.healer { border-color: #47fd2f; background-color: rgba(21, 165, 43, 0.4); }
    .role-box.dps { border-color: #ff3030; background-color: rgba(124, 16, 16, 0.4); }
    .role-box.filled { border-width: 2px; box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2); }

    .job-icon {
        width: 90%; height: 90%; object-fit: contain;
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.8)); 
    }

    .htmx-indicator { opacity: 0; pointer-events: none; transition: opacity 200ms ease-in; }
    #loading-spinner.htmx-request { opacity: 1 !important; pointer-events: all !important; display: flex !important; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

    .fake-header-cell {
        padding: 1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.75rem;
        color: #d1d5db; /* Texto más claro */
    }
</style>
{% endblock %}

{% block content %}
<div class="scanlines opacity-30 pointer-events-none fixed inset-0 z-50"></div> 
<div class="noise opacity-30 pointer-events-none fixed inset-0 z-50"></div>     

<div class="fixed inset-0 w-full h-full z-0">
    <img src="{% static 'img/'|add:raid_slug|add:'.jpg' %}" 
         class="w-full h-full object-cover opacity-40 blur-sm scale-105"
         style="view-transition-name: img-{{ raid_slug }};">
</div>

<div class="relative w-full h-[100dvh] flex flex-col items-center z-10 font-sans overflow-hidden">

    <div class="w-full max-w-[1500px] mt-2 lg:mt-6 mb-2 lg:mb-4 px-4 lg:px-6 flex items-center justify-between shrink-0 z-30">
        <a href="{% url 'home' %}" class="px-4 py-2 rounded-full border border-white/20 bg-zinc-900/60 backdrop-blur-md text-white hover:bg-white hover:text-black transition-all uppercase text-xs font-bold flex items-center gap-2 group shadow-lg">
            <span class="group-hover:-translate-x-1 transition-transform text-sm">←</span> <span>Return</span>
        </a>
        <h1 class="text-xl md:text-4xl font-bold text-white tracking-widest retro-text-shadow text-right uppercase drop-shadow-lg truncate ml-2">
            {{ raid_name }}
        </h1>
    </div>

    <div class="w-full max-w-[1500px] flex-1 flex flex-col overflow-hidden mx-2 lg:mx-6 mb-2 lg:mb-6 rounded-2xl lg:rounded-3xl border border-white/20 bg-[#121212]/95 backdrop-blur-xl shadow-2xl relative" id="pf-system">
        
        {% if error %}
            <div class="flex-1 flex items-center justify-center p-8">
                 <div class="border border-red-500/40 bg-red-900/20 p-6 rounded-xl text-center backdrop-blur-md">
                    <h2 class="text-red-400 font-bold mb-2 text-lg tracking-widest">SIGNAL LOST</h2>
                    <p class="text-gray-300 text-sm">{{ error }}</p>
                 </div>
            </div>
        {% else %}
            
            <div class="p-3 lg:p-5 border-b border-white/10 flex flex-col md:flex-row gap-3 bg-white/5 items-center z-20 shrink-0">
                <div class="relative flex-1 w-full">
                    <input class="search w-full bg-black/40 border border-white/20 text-white p-3 pl-10 rounded-xl text-sm focus:outline-none focus:border-[#fd5d8d]/70 focus:bg-black/60 transition-all placeholder-gray-400 uppercase tracking-wider font-medium shadow-inner" placeholder="SEARCH..." />
                </div>
                
                <div class="relative w-full md:w-auto min-w-[200px]">
                    <select id="dc-filter" class="w-full bg-black/40 text-[#4c6dff] border border-[#2b52ff]/50 py-3 px-4 rounded-xl font-bold uppercase cursor-pointer hover:border-[#2b52ff] transition-all focus:outline-none text-sm tracking-wider appearance-none text-center shadow-lg">
                        <option value="" class="bg-black text-white py-2">ALL DATACENTERS</option>
                        <option value="Aether" class="bg-black text-white py-2">Aether</option>
                        <option value="Primal" class="bg-black text-white py-2">Primal</option>
                        <option value="Crystal" class="bg-black text-white py-2">Crystal</option>
                        <option value="Dynamis" class="bg-black text-white py-2">Dynamis</option>
                    </select>
                </div>
            </div>

            <div class="flex-1 overflow-auto custom-scrollbar relative w-full bg-[#1a1a1a]/40 flex flex-col">
                
                <div class="hidden md:flex flex-row border-b border-white/10 bg-black/40 shadow-md z-10 sticky top-0 backdrop-blur-md">
                    <div class="fake-header-cell w-[10%]">DC</div>
                    <div class="fake-header-cell w-[40%]">Party Info</div> <div class="fake-header-cell w-[30%]">Description</div>
                    <div class="fake-header-cell w-[20%] text-right">Leader</div>
                </div>
                
                <div class="list flex flex-col w-full divide-y divide-white/5"
                     id="pf-results-list"
                     hx-get="{% url 'pf_results' raid_slug %}"
                     hx-trigger="load"
                     hx-indicator="#loading-spinner"
                     hx-swap="innerHTML">
                </div>

                <div id="loading-spinner" class="htmx-indicator absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-50">
                    <div class="flex flex-col items-center p-6 rounded-2xl border border-white/20 bg-zinc-900 shadow-2xl">
                        <div class="w-12 h-12 border-4 border-[#fd5d8d]/40 border-t-[#fd5d8d] rounded-full animate-spin mb-3"></div>
                        <h3 class="text-[#fd5d8d] font-bold tracking-widest text-xs animate-pulse">LOADING...</h3>
                    </div>
                </div>
            </div>

            <div class="p-2 text-center border-t border-white/10 bg-black/40 backdrop-blur-sm z-20 shrink-0">
                <p class="text-[0.6rem] text-gray-400 tracking-wider font-mono">SOURCE FROM xivpf.com/listing</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        var options = { valueNames: [ 'dc', 'desc', 'creator' ] };
        var pfList = new List('pf-system', options);
        
        var dcFilter = document.getElementById('dc-filter');
        var newDcFilter = dcFilter.cloneNode(true);
        dcFilter.parentNode.replaceChild(newDcFilter, dcFilter);
        
        newDcFilter.addEventListener('change', function() {
            var selectedDC = this.value;
            pfList.filter(function(item) {
                return (selectedDC === "") ? true : item.values().dc.trim() === selectedDC;
            });
        });
    });
</script>
{% endblock %}